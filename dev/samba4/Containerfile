# =============================================================================
# Samba4 AD DC – simulace Microsoft Active Directory
#
# Poskytuje LDAP, LDAPS, Kerberos KDC a DNS pro doménu zsstu.local.
# Slouží výhradně pro vývojové prostředí BakaKeeperu.
# =============================================================================

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Instalace Samba4 a pomocných nástrojů
RUN apt-get update && apt-get install -y --no-install-recommends \
    samba \
    samba-dsdb-modules \
    samba-vfs-modules \
    winbind \
    krb5-user \
    ldap-utils \
    dnsutils \
    net-tools \
    iproute2 \
    && rm -rf /var/lib/apt/lists/*

# Odebrání výchozí konfigurace Samby (provisioning ji vytvoří znovu)
RUN rm -f /etc/samba/smb.conf

# Inicializační skripty a schema extension
COPY entrypoint.sh       /entrypoint.sh
COPY provision-users.sh  /provision-users.sh
COPY exchange-schema.ldif /exchange-schema.ldif
RUN chmod +x /entrypoint.sh /provision-users.sh

# Porty poskytovaných služeb:
#   53   – DNS (interní pro doménu; na hostiteli mapováno na 15353)
#   88   – Kerberos KDC
#   389  – LDAP
#   636  – LDAPS
#   3268 – LDAP Global Catalog
#   3269 – LDAPS Global Catalog
#   445  – SMB (RPC)
#   464  – kpasswd
EXPOSE 53/tcp 53/udp 88/tcp 88/udp 389/tcp 636/tcp 3268/tcp 3269/tcp 445/tcp 464/tcp 464/udp

VOLUME ["/var/lib/samba", "/keytabs"]

ENTRYPOINT ["/entrypoint.sh"]
